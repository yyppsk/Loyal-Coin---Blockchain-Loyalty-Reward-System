<!DOCTYPE html>
<html>
  <head>
    <title>Loyalty Token Test</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.3.0/dist/web3.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <div class="bg-white rounded-lg p-6 shadow-lg">
        <h1 class="text-3xl font-semibold mb-4">Flipkartcoin Dashboard</h1>
        <h2 class="font-semibold mb-4">
          You're logged in as : <span id="loggedin" class="font-bold"></span>
        </h2>
        <p>
          Your Token Balance: <span id="balance" class="font-bold"></span> FKC
        </p>
      </div>

      <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-white rounded-lg p-6 shadow-lg">
          <h2 class="text-xl font-semibold mb-4">Earn Tokens</h2>
          <button
            id="earnButton"
            class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md"
          >
            Earn
          </button>
        </div>

        <div class="bg-white rounded-lg p-6 shadow-lg">
          <!-- Add an input field for redeeming tokens -->
          <div class="mt-4">
            <label
              for="redeemAmount"
              class="block text-sm font-medium text-gray-700"
              >Redeem Amount</label
            >
            <div class="mt-1">
              <input
                type="number"
                id="redeemAmount"
                name="redeemAmount"
                class="shadow-sm focus:ring-indigo-500 focus:border-indigo-500 block w-full sm:text-sm border-gray-300 rounded-md"
                placeholder="Enter amount to redeem"
              />
            </div>
          </div>

          <!-- Add a redeem button -->
          <button
            id="redeemButton"
            type="button"
            class="mt-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
          >
            Redeem Tokens
          </button>
        </div>
      </div>

      <div class="mt-8 bg-white rounded-lg p-6 shadow-lg">
        <h2 class="text-xl font-semibold mb-4">Transfer Tokens</h2>
        <div class="mb-4">
          <label for="toAddress" class="block text-sm font-medium text-gray-700"
            >To Address</label
          >
          <input
            type="text"
            id="toAddress"
            class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
          />
        </div>
        <div class="mb-4">
          <label
            for="transferAmount"
            class="block text-sm font-medium text-gray-700"
            >Amount</label
          >
          <input
            type="number"
            id="transferAmount"
            class="mt-1 focus:ring-indigo-500 focus:border-indigo-500 block w-full shadow-sm sm:text-sm border-gray-300 rounded-md"
          />
        </div>
        <button
          id="transferButton"
          class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md"
        >
          Transfer
        </button>
      </div>
    </div>
    <script>
      document.addEventListener("DOMContentLoaded", async () => {
        let provider;

        if (typeof web3 !== "undefined") {
          provider = web3.currentProvider;
        } else {
          alert("Please install MetaMask or use a compatible browser.");
        }

        const web3Instance = new Web3(provider);

        const contractAddress = "0x9d21D7f68237260A5F2Dd220F0c9c07e55A89ae6";
        const contractABI = [
          {
            inputs: [],
            stateMutability: "nonpayable",
            type: "constructor",
          },
          {
            inputs: [],
            name: "InvalidShortString",
            type: "error",
          },
          {
            inputs: [
              {
                internalType: "string",
                name: "str",
                type: "string",
              },
            ],
            name: "StringTooLong",
            type: "error",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "address",
                name: "owner",
                type: "address",
              },
              {
                indexed: true,
                internalType: "address",
                name: "spender",
                type: "address",
              },
              {
                indexed: false,
                internalType: "uint256",
                name: "value",
                type: "uint256",
              },
            ],
            name: "Approval",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [],
            name: "EIP712DomainChanged",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: false,
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "Paused",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                indexed: true,
                internalType: "bytes32",
                name: "previousAdminRole",
                type: "bytes32",
              },
              {
                indexed: true,
                internalType: "bytes32",
                name: "newAdminRole",
                type: "bytes32",
              },
            ],
            name: "RoleAdminChanged",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                indexed: true,
                internalType: "address",
                name: "account",
                type: "address",
              },
              {
                indexed: true,
                internalType: "address",
                name: "sender",
                type: "address",
              },
            ],
            name: "RoleGranted",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                indexed: true,
                internalType: "address",
                name: "account",
                type: "address",
              },
              {
                indexed: true,
                internalType: "address",
                name: "sender",
                type: "address",
              },
            ],
            name: "RoleRevoked",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "address",
                name: "account",
                type: "address",
              },
              {
                indexed: false,
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "TokensEarned",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "address",
                name: "account",
                type: "address",
              },
              {
                indexed: false,
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "TokensRedeemed",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: true,
                internalType: "address",
                name: "from",
                type: "address",
              },
              {
                indexed: true,
                internalType: "address",
                name: "to",
                type: "address",
              },
              {
                indexed: false,
                internalType: "uint256",
                name: "value",
                type: "uint256",
              },
            ],
            name: "Transfer",
            type: "event",
          },
          {
            anonymous: false,
            inputs: [
              {
                indexed: false,
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "Unpaused",
            type: "event",
          },
          {
            inputs: [],
            name: "DEFAULT_ADMIN_ROLE",
            outputs: [
              {
                internalType: "bytes32",
                name: "",
                type: "bytes32",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [],
            name: "DOMAIN_SEPARATOR",
            outputs: [
              {
                internalType: "bytes32",
                name: "",
                type: "bytes32",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [],
            name: "MINTER_ROLE",
            outputs: [
              {
                internalType: "bytes32",
                name: "",
                type: "bytes32",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [],
            name: "PAUSER_ROLE",
            outputs: [
              {
                internalType: "bytes32",
                name: "",
                type: "bytes32",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "owner",
                type: "address",
              },
              {
                internalType: "address",
                name: "spender",
                type: "address",
              },
            ],
            name: "allowance",
            outputs: [
              {
                internalType: "uint256",
                name: "",
                type: "uint256",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "spender",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "approve",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "balanceOf",
            outputs: [
              {
                internalType: "uint256",
                name: "",
                type: "uint256",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "burn",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "account",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "burnFrom",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [],
            name: "decimals",
            outputs: [
              {
                internalType: "uint8",
                name: "",
                type: "uint8",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "spender",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "subtractedValue",
                type: "uint256",
              },
            ],
            name: "decreaseAllowance",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [],
            name: "eip712Domain",
            outputs: [
              {
                internalType: "bytes1",
                name: "fields",
                type: "bytes1",
              },
              {
                internalType: "string",
                name: "name",
                type: "string",
              },
              {
                internalType: "string",
                name: "version",
                type: "string",
              },
              {
                internalType: "uint256",
                name: "chainId",
                type: "uint256",
              },
              {
                internalType: "address",
                name: "verifyingContract",
                type: "address",
              },
              {
                internalType: "bytes32",
                name: "salt",
                type: "bytes32",
              },
              {
                internalType: "uint256[]",
                name: "extensions",
                type: "uint256[]",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
            ],
            name: "getRoleAdmin",
            outputs: [
              {
                internalType: "bytes32",
                name: "",
                type: "bytes32",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "grantRole",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "hasRole",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "spender",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "addedValue",
                type: "uint256",
              },
            ],
            name: "increaseAllowance",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [],
            name: "name",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "owner",
                type: "address",
              },
            ],
            name: "nonces",
            outputs: [
              {
                internalType: "uint256",
                name: "",
                type: "uint256",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [],
            name: "paused",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "owner",
                type: "address",
              },
              {
                internalType: "address",
                name: "spender",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "value",
                type: "uint256",
              },
              {
                internalType: "uint256",
                name: "deadline",
                type: "uint256",
              },
              {
                internalType: "uint8",
                name: "v",
                type: "uint8",
              },
              {
                internalType: "bytes32",
                name: "r",
                type: "bytes32",
              },
              {
                internalType: "bytes32",
                name: "s",
                type: "bytes32",
              },
            ],
            name: "permit",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "renounceRole",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "bytes32",
                name: "role",
                type: "bytes32",
              },
              {
                internalType: "address",
                name: "account",
                type: "address",
              },
            ],
            name: "revokeRole",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "bytes4",
                name: "interfaceId",
                type: "bytes4",
              },
            ],
            name: "supportsInterface",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [],
            name: "symbol",
            outputs: [
              {
                internalType: "string",
                name: "",
                type: "string",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [],
            name: "totalSupply",
            outputs: [
              {
                internalType: "uint256",
                name: "",
                type: "uint256",
              },
            ],
            stateMutability: "view",
            type: "function",
            constant: true,
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "to",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "transfer",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "from",
                type: "address",
              },
              {
                internalType: "address",
                name: "to",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "transferFrom",
            outputs: [
              {
                internalType: "bool",
                name: "",
                type: "bool",
              },
            ],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [],
            name: "pause",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [],
            name: "unpause",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "address",
                name: "to",
                type: "address",
              },
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "mint",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "earnTokens",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
          {
            inputs: [
              {
                internalType: "uint256",
                name: "amount",
                type: "uint256",
              },
            ],
            name: "redeemTokens",
            outputs: [],
            stateMutability: "nonpayable",
            type: "function",
          },
        ]; // Replace with your contract's ABI
        const accounts = await ethereum.request({
          method: "eth_requestAccounts",
        });
        const userAddress = accounts[0];
        const contractInstance = new web3.eth.Contract(
          contractABI,
          contractAddress
        );
        async function updateBalance(userAddress) {
          try {
            const balance = await contractInstance.methods
              .balanceOf(userAddress)
              .call();

            // Convert the balance from wei to FKC format
            const balanceInFKC = web3.utils.fromWei(balance, "ether");
            document.getElementById("balance").textContent =
              userAddress + balanceInFKC;
            //Displaying who's logged in via metamask
            document.getElementById("loggedin").textContent = userAddress;
          } catch (error) {
            console.error("Error updating balance:", error);
          }
        }

        updateBalance(userAddress);

        document
          .getElementById("earnButton")
          .addEventListener("click", async () => {
            try {
              const amountToEarn = 100; // Specify the amount of tokens to earn
              const accounts = await ethereum.request({
                method: "eth_requestAccounts",
              });
              const userAddress = accounts[0];
              const txParams = {
                to: contractAddress,
                from: userAddress,
                data: contractInstance.methods
                  .earnTokens(amountToEarn)
                  .encodeABI(),
              };

              const txHash = await ethereum.request({
                method: "eth_sendTransaction",
                params: [txParams],
              });
              console.log("Earn transaction hash:", txHash);

              updateBalance();
            } catch (error) {
              console.error("Error earning tokens:", error);
            }
          });

        document
          .getElementById("redeemButton")
          .addEventListener("click", async () => {
            try {
              const amountToRedeem = 50; // Specify the amount of tokens to redeem
              const accounts = await ethereum.request({
                method: "eth_requestAccounts",
              });
              const userAddress = accounts[0];
              const txParams = {
                to: contractAddress,
                from: userAddress,
                data: contractInstance.methods
                  .redeemTokens(amountToRedeem)
                  .encodeABI(),
              };

              const txHash = await ethereum.request({
                method: "eth_sendTransaction",
                params: [txParams],
              });
              console.log("Redeem transaction hash:", txHash);

              updateBalance();
            } catch (error) {
              console.error("Error redeeming tokens:", error);
            }
          });

        document
          .getElementById("transferButton")
          .addEventListener("click", async () => {
            try {
              const toAddress = document.getElementById("toAddress").value;
              const amount = document.getElementById("transferAmount").value;
              const accounts = await ethereum.request({
                method: "eth_requestAccounts",
              });
              const userAddress = accounts[0];
              const txParams = {
                to: contractAddress,
                from: userAddress,
                data: contractInstance.methods
                  .transfer(toAddress, amount)
                  .encodeABI(),
              };

              const txHash = await ethereum.request({
                method: "eth_sendTransaction",
                params: [txParams],
              });
              console.log("Transfer transaction hash:", txHash);

              updateBalance();
            } catch (error) {
              console.error("Error transferring tokens:", error);
            }
          });

        if (!isReturningUser) {
          // Runs only if they are brand new, or have hit the disconnect button
          await window.ethereum.request({
            method: "wallet_requestPermissions",
            params: [
              {
                eth_accounts: {},
              },
            ],
          });
        }
      });
    </script>
    <script src="app.js"></script>
  </body>
</html>
