<!DOCTYPE html>
<html>
<head>
    <title>Product Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://unpkg.com/tabulator-tables@5.5.0/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@5.5.0/dist/js/tabulator.min.js"></script>
    <!-- Include the Borderless theme -->

<style>
    /* Custom styles for Tabulator */
    .tabulator .tabulator-header {
        background-color: #f3f4f6;
    }
    .tabulator .tabulator-header .tabulator-col {
        border-right: 1px solid #d1d5db;
    }
    .tabulator .tabulator-header .tabulator-col:last-child {
        border-right: none;
    }
    .tabulator-row {
        border-bottom: 1px solid #d1d5db;
    }
    .tabulator-row.tabulator-selected {
        background-color: #e5e7eb;
    }
</style>
</head>
<body class="bg-gray-100">
    <nav class="bg-blue-500 text-white p-4">
        <div class="container mx-auto flex justify-between items-center">
          <h1 class="text-2xl font-semibold">Shopping Site</h1>
          <div>
            <!-- Add more navigation links here if needed -->
          </div>
        </div>
      </nav>
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-semibold mb-4">Styled Product Management</h1>
    <div class="bg-white rounded p-4 shadow">
        <!-- Search form -->
        <div class="flex items-center mb-4">
            <label for="search" class="mr-2">Search:</label>
            <input type="text" id="search" class="border rounded px-2 py-1">
        </div>

        <!-- Category filter -->
        <div class="flex items-center mb-4">
            <label for="category" class="mr-2">Category:</label>
            <select id="categories" class="border rounded px-2 py-1">
                <option value="">All categories</option>
                <!-- Options will be populated dynamically -->
            </select>
        </div>

        <!-- Products table -->
        <div id="product-table"></div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-center mt-4"></div>
    </div>
</div>
    <script>
        async function fetchCategories() {
        try {
            const response = await fetch('/api/categories');
            const categories = await response.json();

            const categorySelect = document.getElementById('categories');
            categories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            option.textContent = category;
            categorySelect.appendChild(option);
            });
        } catch (error) {
            console.error('Error fetching categories:', error);
        }
        }
        // Call the function to fetch and populate categories
        fetchCategories();

         const productTable = new Tabulator("#product-table", {
            columns: [
                { title: "Product ID", field: "product_id", sorter: "number"},
                { title: "Name", field: "name", sorter: "string", resizable: true  },
                { title: "Category", field: "category", sorter: "string" },
                { title: "Cost", field: "cost", sorter: "number" },
                { title: "Actions", formatter: actionButtons, headerSort: false, width: 200 },
                    ],
                    layout: "fitColumns",
                    pagination: "local",
                    paginationSize: 10,
                    data: [], // Initialize with empty data
                    initialSort: [
                    { column: "name", dir: "asc" }, // Initial sorting by product name in ascending order
                    ],
                    initialFilter: [],
                });

                    // Custom formatter to generate action buttons
                    function actionButtons(cell, formatterParams, onRendered) {
                        const row = cell.getRow();
                        const rowData = row.getData();
                        const productId = rowData.product_id;
                        return `<button class="edit-button" data-id="${productId}">Edit</button><button class="delete-button" data-id="${productId}">Delete</button>`;
                    }

                    // Function to handle button clicks (Edit and Delete)
                    document.addEventListener("click", async (e) => {
                        if (e.target.classList.contains("edit-button")) {
                        const row = e.target.closest(".tabulator-row");
                        const productId = e.target.getAttribute("data-id");

                        const rowData = productTable.getRow(row).getData();

                        const inputFields = Object.keys(rowData).map((key) => {
                            return `
                                <label for="${key}">${key}:</label>
                                <input type="text" id="${key}" value="${rowData[key]}" class="swal2-input">
                            `;
                        }).join('');

                    const { value: modifiedData, isConfirmed } = await Swal.fire({
                        title: 'Edit Product',
                        html: inputFields,
                        focusConfirm: false,
                        preConfirm: () => {
                            const data = {};
                            Object.keys(rowData).forEach((key) => {
                                data[key] = document.getElementById(key).value;
                            });
                            return data;
                        },
                        showCancelButton: true,
                        confirmButtonText: 'Save',
                    });

                if (isConfirmed) {
                    try {
                        const response = await fetch(`/api/products/${productId}`, {
                            method: "PUT",
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify(modifiedData),
                        });
                        if (response.ok) {
                            Swal.fire({
                                icon: 'success',
                                title: 'Product data updated successfully',
                                showConfirmButton: false,
                                timer: 1500
                            });
                            fetchData(); // Refresh table data
                        } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed to update product data',
                        showConfirmButton: false,
                        timer: 1500
                    });
                }
            } catch (error) {
                console.error(error);
            }
        }
    }
    else if (e.target.classList.contains("delete-button")) {
    const productId = e.target.getAttribute("data-id");

    // Show a SweetAlert2 confirmation dialog
    const { isConfirmed } = await Swal.fire({
      icon: "warning",
      title: "Confirm Deletion",
      text: "Are you sure you want to delete this product?",
      showCancelButton: true,
      confirmButtonText: "Yes, delete it",
      cancelButtonText: "Cancel",
    });

    if (isConfirmed) {
      try {
        const response = await fetch(`/api/products/${productId}`, {
          method: "DELETE",
        });

        if (response.ok) {
          Swal.fire({
            icon: "success",
            title: "Product deleted successfully",
            showConfirmButton: false,
            timer: 1500,
          });
          fetchData(); // Refresh table data
        } else {
          Swal.fire({
            icon: "error",
            title: "Failed to delete product",
            showConfirmButton: false,
            timer: 1500,
          });
        }
      } catch (error) {
        console.error(error);
      }
    }
  }
});

         // Fetch and load data into the table
         async function fetchData() {
            try {
                const response = await fetch('/api/products');
                const data = await response.json();
                productTable.setData(data);
              
                const selectedCategory = document.getElementById('categories').value;

                // Create the initial filter object based on the selected category
                const initialFilter = selectedCategory
                ? [{ field: 'category', type: '=', value: selectedCategory }]
                : [];

                // Initialize the Tabulator table with data and initial filter
                productTable.setData(data);
                productTable.setFilter(initialFilter);
                } catch (error) {
                    console.error(error);
                }
            }

        // Load initial data
        fetchData();
    </script>
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <div class="mt-6 flex justify-center">
        <button class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600">Previous</button>
        <button class="bg-blue-500 text-white px-4 py-2 rounded-full hover:bg-blue-600 ml-4">Next</button>
      </div>
    </div>
</body>
</html>
